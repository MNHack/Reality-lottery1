<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>لوحة تحكم الدفع</title>
  <style>
    /* نفس التصميم السابق */
  </style>
</head>
<body>
  <h2>📋 لوحة تحكم الدفع</h2>
  
  <div class="search-box">
    <input type="text" id="searchInput" placeholder="🔍 ابحث عن مستخدم أو رقم العملية أو الهاتف...">
  </div>
  
  <table>
    <thead>
      <tr>
        <th>رقم العملية</th>
        <th>رقم الهاتف</th>
        <th>الحالة</th>
        <th>التاريخ</th>
        <th>إجراءات</th>
      </tr>
    </thead>
    <tbody id="paymentTable">
      <tr><td colspan="5">جارٍ تحميل البيانات...</td></tr>
    </tbody>
  </table>
  
  <script>
    let allPayments = [];
    
    // دالة لجلب البيانات من السيرفر
    async function loadPayments() {
      try {
        const response = await fetch("https://realitylottery.koyeb.app/api/pending-payments");
        
        if (!response.ok) {
          throw new Error("فشل في جلب البيانات من الخادم");
        }
        
        allPayments = await response.json();
        renderTable(allPayments);
      } catch (err) {
        console.error("Error loading payments:", err);
        document.getElementById("paymentTable").innerHTML = `
          <tr>
            <td colspan="5">
              خطأ في تحميل البيانات: ${err.message}
              <button onclick="location.reload()">إعادة المحاولة</button>
            </td>
          </tr>`;
      }
    }
    
    // دالة لعرض البيانات في الجدول
    function renderTable(payments) {
      const table = document.getElementById("paymentTable");
      table.innerHTML = "";
      
      if (!payments || payments.length === 0) {
        table.innerHTML = `<tr><td colspan="5">لا توجد طلبات دفع حالياً</td></tr>`;
        return;
      }
      
      payments.forEach(payment => {
        const date = new Date(payment.date).toLocaleString("ar-EG");
        const statusColor = payment.status === "pending" ? "orange" : 
                           payment.status === "approved" ? "green" : "red";
        
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${payment.txid || "-"}</td>
          <td>${payment.phone || "-"}</td>
          <td style="color: ${statusColor}; font-weight: bold;">
            ${payment.status || "pending"}
          </td>
          <td>${date}</td>
          <td>
            <button class="approve" onclick="updateStatus('${payment._id}', 'approved')">
              موافقة
            </button>
            <button class="reject" onclick="updateStatus('${payment._id}', 'rejected')">
              رفض
            </button>
          </td>
        `;
        table.appendChild(row);
      });
    }
    
    // دالة لتحديث حالة الدفع
    async function updateStatus(id, status) {
      try {
        const response = await fetch(`https://realitylottery.koyeb.app/api/payment/${id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ status })
        });
        
        if (!response.ok) {
          throw new Error("فشل في تحديث الحالة");
        }
        
        // إعادة تحميل البيانات بعد التحديث
        loadPayments();
        alert("تم تحديث الحالة بنجاح");
      } catch (err) {
        console.error("Error updating status:", err);
        alert(`خطأ في تحديث الحالة: ${err.message}`);
      }
    }
    
    // فلتر البحث
    document.getElementById("searchInput").addEventListener("input", function() {
      const query = this.value.toLowerCase();
      const filtered = allPayments.filter(payment => 
        (payment.txid && payment.txid.toLowerCase().includes(query)) ||
        (payment.phone && payment.phone.toLowerCase().includes(query))
      );
      renderTable(filtered);
    });
    
    // تحميل البيانات عند فتح الصفحة
    loadPayments();
    
    // تحديث البيانات كل 30 ثانية
    setInterval(loadPayments, 30000);
  </script>
</body>
</html>
